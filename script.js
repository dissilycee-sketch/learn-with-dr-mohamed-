let currentChallenge = '', questions = [], currentQuestionIndex = 0, score = 0;

function startChallengeSelection() {
  const n = document.getElementById('student-name').value.trim();
  const c = document.getElementById('student-class').value.trim();
  const l = document.getElementById('student-level').value;
  if (!n || !c || !l) { alert('يرجى ملء جميع المعلومات'); return; }
  document.getElementById('student-info').classList.add('hidden');
  document.getElementById('challenge-selection').classList.remove('hidden');
}

function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function startQuiz(challenge) {
  currentChallenge = challenge;
  document.getElementById('challenge-selection').classList.add('hidden');
  document.getElementById('quiz-container').classList.remove('hidden');

  const titles = {
    institution: 'تحدي المؤسسة الإنتاجية',
    representation: 'تحدي اتفاقيات التمثيل',
    cad: 'تحدي الرسم بالحاسوب',
    tech: 'تحدي التكنولوجيا والمنتوج التقني',
    project: 'تحدي مسعى المشروع'
  };
  document.getElementById('challenge-title').textContent = titles[challenge];

  const bank = {
    institution: [
      {q:'ما المقصود بالمؤسسة الإنتاجية؟',a:['وحدة تهدف إلى إنتاج سلع أو خدمات','منظمة خيرية','مؤسسة تربوية'],c:'وحدة تهدف إلى إنتاج سلع أو خدمات'},
      {q:'من عناصر المحيط الخارجي للمؤسسة؟',a:['الزبائن والمنافسون والسوق','العمال فقط','الإدارة'],c:'الزبائن والمنافسون والسوق'},
      {q:'ما هدف الإنتاج؟',a:['تلبية حاجات المستهلك','زيادة البطالة','رفع الأسعار'],c:'تلبية حاجات المستهلك'},
      {q:'من يمثل الزبون بالنسبة للمؤسسة؟',a:['المستفيد من المنتج أو الخدمة','صاحب المؤسسة','المورد'],c:'المستفيد من المنتج أو الخدمة'},
      {q:'ما علاقة المؤسسة بالسوق؟',a:['علاقة تبادل للسلع والخدمات','علاقة تعليمية','لا توجد علاقة'],c:'علاقة تبادل للسلع والخدمات'},
      {q:'ما المقصود بالتكنولوجيا؟',a:['مجموعة المعارف والوسائل المستخدمة في الإنتاج','فن الرسم','علم الاقتصاد'],c:'مجموعة المعارف والوسائل المستخدمة في الإنتاج'},
      {q:'من العوامل الداخلية للمؤسسة؟',a:['رأس المال والموارد البشرية','الضرائب','الزبائن'],c:'رأس المال والموارد البشرية'},
      {q:'ما الذي يحدد كمية الإنتاج؟',a:['حجم الطلب وطاقـة المؤسسة','عدد العمال فقط','الزمن'],c:'حجم الطلب وطاقـة المؤسسة'},
      {q:'ما المقصود بالمنتوج؟',a:['نتيجة عملية الإنتاج','وسيلة الإنتاج','الخدمة العمومية'],c:'نتيجة عملية الإنتاج'},
      {q:'الزبون هو...',a:['شخص يشتري سلعة أو خدمة','العامل في المؤسسة','صاحب رأس المال'],c:'شخص يشتري سلعة أو خدمة'},
      {q:'من عناصر المؤسسة المادية؟',a:['المباني والآلات','العمال','المسير'],c:'المباني والآلات'},
      {q:'من أهم وظائف المؤسسة؟',a:['الإنتاج والتسويق','التدريس','التحقيق'],c:'الإنتاج والتسويق'},
      {q:'تعمل المؤسسة ضمن...',a:['وسط تكنولوجي واقتصادي','وسط طبيعي فقط','وسط مدرسي'],c:'وسط تكنولوجي واقتصادي'},
      {q:'العنصر البشري يمثل...',a:['القوة العاملة في المؤسسة','الزبائن','المنافسين'],c:'القوة العاملة في المؤسسة'},
      {q:'الموارد المالية هي...',a:['رأس المال والسيولة','المواد الأولية','المنتوجات'],c:'رأس المال والسيولة'}
    ],
    representation: [
      {q:'ما المقصود باتفاقيات التمثيل؟',a:['قواعد لتنظيم الرسم التقني','قوانين تجارية','نظريات في الفيزياء'],c:'قواعد لتنظيم الرسم التقني'},
      {q:'ما المقصود بالمقياس في الرسم؟',a:['نسبة تصغير أو تكبير الأبعاد','نوع الخط','رمز المؤسسة'],c:'نسبة تصغير أو تكبير الأبعاد'},
      {q:'ما وظيفة جدول التسجيل؟',a:['تقديم بيانات حول الرسم','زخرفة الورقة','إضافة ألوان'],c:'تقديم بيانات حول الرسم'},
      {q:'ما وظيفة جدول التعيين؟',a:['توضيح أسماء وأرقام الأجزاء','إظهار المقاييس','إضافة الظلال'],c:'توضيح أسماء وأرقام الأجزاء'},
      {q:'الخط المتقطع يُستخدم ل...',a:['تمثيل الأجزاء غير المرئية','الحدود الخارجية','المحاور'],c:'تمثيل الأجزاء غير المرئية'},
      {q:'الخط المستمر الغليظ يُستخدم ل...',a:['الحدود الظاهرة','المحاور','المقاطع'],c:'الحدود الظاهرة'},
      {q:'التمثيل الأورتوغرافي يعني...',a:['الإسقاط العمودي على المساقط','الرسم المنظوري','التصميم الحر'],c:'الإسقاط العمودي على المساقط'},
      {q:'رمز المساقط E يعني...',a:['الاتجاه الأوروبي للمساقط','الاتجاه الأمريكي','الاتجاه الآسيوي'],c:'الاتجاه الأوروبي للمساقط'},
      {q:'المنظر الأمامي يُرسم على...',a:['المسقط العمودي الأمامي','المسقط الجانبي','المسقط العلوي'],c:'المسقط العمودي الأمامي'},
      {q:'المقياس 1:2 يعني...',a:['تصغير بمقدار النصف','تكبير مرتين','مساوي للحجم الحقيقي'],c:'تصغير بمقدار النصف'},
      {q:'الخط المحوري يُستخدم ل...',a:['تمثيل محور التناظر','إظهار حدود القطع','إخفاء التفاصيل'],c:'تمثيل محور التناظر'},
      {q:'الرسم التقني لغة...',a:['التقنيين والمهندسين','الأدباء','المبرمجين'],c:'التقنيين والمهندسين'},
      {q:'المنظر الجانبي الأيمن يُوضع...',a:['على يمين المنظر الأمامي','على يساره','أسفل المنظر العلوي'],c:'على يمين المنظر الأمامي'},
      {q:'المساقط الثلاثة هي...',a:['أمامي، علوي، جانبي','أفقي، عمودي، مائل','منظوري، حر، تخطيطي'],c:'أمامي، علوي، جانبي'},
      {q:'الرموز في الرسم تُستعمل لـ...',a:['توحيد الفهم بين المصممين','زخرفة الورقة','التمييز بين الألوان'],c:'توحيد الفهم بين المصممين'}
    ],
    cad: [
      {q:'ما وظيفة برنامج AutoCAD؟',a:['إنشاء الرسومات التقنية','تشغيل الفيديو','تحليل البيانات'],c:'إنشاء الرسومات التقنية'},
      {q:'ما المقصود بـ SolidWorks؟',a:['برنامج تصميم ثلاثي الأبعاد','برنامج معالجة نصوص','أداة محاسبة'],c:'برنامج تصميم ثلاثي الأبعاد'},
      {q:'في واجهة SolidWorks نجد...',a:['شريط الأدوات، منطقة الرسم، المتصفح','شريط مهام ويندوز','مفكرة النصوص'],c:'شريط الأدوات، منطقة الرسم، المتصفح'},
      {q:'أداة الخط المستقيم تُستخدم لـ...',a:['رسم خطوط بين نقطتين','إدراج نص','تلوين الشكل'],c:'رسم خطوط بين نقطتين'},
      {q:'أداة الدائرة تُستخدم لـ...',a:['رسم دوائر','رسم خطوط منكسرة','كتابة الأبعاد'],c:'رسم دوائر'},
      {q:'تصميم التجميع يعني...',a:['جمع عدة قطع في نموذج واحد','رسم قطعة منفردة','كتابة تقرير'],c:'جمع عدة قطع في نموذج واحد'},
      {q:'الحفظ بالامتداد .SLDPRT يعني...',a:['ملف قطعة في SolidWorks','ملف نصي','ملف موسيقي'],c:'ملف قطعة في SolidWorks'},
      {q:'الحفظ بالامتداد .SLDASM يعني...',a:['ملف تجميع','ملف نصي','ملف رسم ثنائي'],c:'ملف تجميع'},
      {q:'أداة القياس تُستخدم لـ...',a:['معرفة الأبعاد','تحريك الأشكال','تلوين الأجزاء'],c:'معرفة الأبعاد'},
      {q:'تصميم قطعة يعني...',a:['رسم شكل ثلاثي الأبعاد لعنصر','جمع القطع','تحليل الصوت'],c:'رسم شكل ثلاثي الأبعاد لعنصر'},
      {q:'ما المقصود بالمستوي في SolidWorks؟',a:['سطح يُرسم عليه الأشكال','حجم مجسم','ملف صوتي'],c:'سطح يُرسم عليه الأشكال'},
      {q:'أداة الإخراج الخطي تُستخدم لـ...',a:['تحويل رسم ثنائي إلى مجسم','تلوين الوجوه','قص الشكل'],c:'تحويل رسم ثنائي إلى مجسم'},
      {q:'واجهة البرنامج تتضمن...',a:['القوائم، الأشرطة، نافذة الرسم','الملفات فقط','الكاميرا'],c:'القوائم، الأشرطة، نافذة الرسم'},
      {q:'الحفظ المنتظم للعمل يكون بـ...',a:['Ctrl + S','Ctrl + C','Ctrl + P'],c:'Ctrl + S'},
      {q:'أمر "Zoom Extents" يفيد في...',a:['إظهار كامل الرسم في الشاشة','تكبير جزء صغير','تغيير اللون'],c:'إظهار كامل الرسم في الشاشة'}
    ],
    tech: [
      {q:'ما تعريف التكنولوجيا؟',a:['تطبيق المعرفة والأدوات لحل المشكلات','فن التقليد','نوع من الرياضة'],c:'تطبيق المعرفة والأدوات لحل المشكلات'},
      {q:'ما الفرق بين جهاز ومنتوج تقني؟',a:['الجهاز جزء من المنتوج أو أداة تستخدم','لا يوجد فرق','المنتوج هو مادة خام فقط'],c:'الجهاز جزء من المنتوج أو أداة تستخدم'},
      {q:'ما المقصود بمرحلة التصنيع؟',a:['تحويل المواد الأولية إلى منتوج نهائي','التفكير النظري فقط','التوزيع في السوق'],c:'تحويل المواد الأولية إلى منتوج نهائي'},
      {q:'ما دور الصيانة في عمر المنتوج؟',a:['إطالة عمر المنتوج وضمان الأداء','زيادة التكلفة فقط','ليس لها دور'],c:'إطالة عمر المنتوج وضمان الأداء'},
      {q:'ما المقصود بالمواصفات الفنية؟',a:['الخصائص التي يلتزم بها المنتوج','لوائح تسويقية','شعارات تجارية'],c:'الخصائص التي يلتزم بها المنتوج'},
      {q:'ما دور الاختبارات في تطوير المنتوج؟',a:['التحقق من سلامة وفعالية المنتوج','إضافة ألوان','زيادة الأرباح فقط'],c:'التحقق من سلامة وفعالية المنتوج'},
      {q:'ما المقصود بالتحكم في الجودة؟',a:['مجموعة إجراءات لضمان مطابقة المواصفات','تصميم العبوة','تعليم المستخدم'],c:'مجموعة إجراءات لضمان مطابقة المواصفات'},
      {q:'المنهجية العلمية في تطوير منتوج تبدأ بـ...',a:['تحديد المشكلة ووضع فرضيات','التسويق مباشرة','التخمين'],c:'تحديد المشكلة ووضع فرضيات'},
      {q:'ما المقصود بالابتكار؟',a:['إيجاد حل جديد أو تحسين لحاجة قائمة','سرقة فكرة','إنتاج بكميات كبيرة'],c:'إيجاد حل جديد أو تحسين لحاجة قائمة'},
      {q:'ما أهمية دراسة احتياجات المستخدم؟',a:['لضمان أن المنتج يحل مشكلة فعلية','غير مهمة','لزيادة التعقيد فقط'],c:'لضمان أن المنتج يحل مشكلة فعلية'},
      {q:'ما المقصود بدورة حياة المنتوج؟',a:['مراحل المنتج من التصميم إلى التخلص','فترة الضمان فقط','مدة الاستخدام الوحيدة'],c:'مراحل المنتج من التصميم إلى التخلص'},
      {q:'ما المقصود بتكنولوجيا بسيطة؟',a:['تكنولوجيا سهلة الفهم والاستخدام','تكنولوجيا متطورة جدا','مصطلح غير مستخدم'],c:'تكنولوجيا سهلة الفهم والاستخدام'},
      {q:'أمثلة على مصادر الطاقة في المنتجات التقنية؟',a:['كهرباء، بطارية، طاقة شمسية','صخور، ضوء','صوت'],c:'كهرباء، بطارية، طاقة شمسية'},
      {q:'ما المقصود بالمجلى (prototype)؟',a:['نموذج أولي لاختبار الفكرة','المنتج النهائي للبيع','وثيقة تقنية'],c:'نموذج أولي لاختبار الفكرة'},
      {q:'ما الهدف من التغليف الجيد؟',a:['حماية المنتج وتسهيل النقل','جذب الزبائن فقط','زيادة الوزن'],c:'حماية المنتج وتسهيل النقل'}
    ],
    project: [
      {q:'ما هو مسعى المشروع؟',a:['خطة لإنجاز منتوج أو نشاط تكنولوجي','مسابقة رياضية','قصة مدرسية'],c:'خطة لإنجاز منتوج أو نشاط تكنولوجي'},
      {q:'ما خطوات المسعى التكنولوجي؟',a:['تحديد المشكلة، البحث، التصميم، التنفيذ، التقييم','الشراء فقط','التدريس فقط'],c:'تحديد المشكلة، البحث، التصميم، التنفيذ، التقييم'},
      {q:'ما دور التحليل الوظيفي؟',a:['تحديد وظائف الجزء وأهميته','تلوين النموذج','التسويق فقط'],c:'تحديد وظائف الجزء وأهميته'},
      {q:'ما المقصود بمخطط التدفق (Flowchart)؟',a:['تمثيل خطوات العملية ترتيبياً','رسم زخرفي','قائمة المواد فقط'],c:'تمثيل خطوات العملية ترتيبياً'},
      {q:'ما أهمية تحديد الموارد في المشروع؟',a:['للتخطيط الجيد وتفادي الانقطاع','غير مهمة','لتجميل العرض فقط'],c:'للتخطيط الجيد وتفادي الانقطاع'},
      {q:'ما المقصود ببرمجة زمنية للمشروع؟',a:['جدول يحدد مواعيد الأنشطة','قائمة أسماء','وصفة طعام'],c:'جدول يحدد مواعيد الأنشطة'},
      {q:'ما أهمية اختبار المنتج النهائي؟',a:['التأكد من أن المنتج يعمل وفق المواصفات','زيادة التكلفة فقط','لا فائدة منها'],c:'التأكد من أن المنتج يعمل وفق المواصفات'},
      {q:'ما المقصود بالتوثيق في المشروع؟',a:['جمع وتقنين معلومات العمل والنتائج','التصوير فقط','التنظيف فقط'],c:'جمع وتقنين معلومات العمل والنتائج'},
      {q:'ما دور الفريق في إنجاز المشروع؟',a:['توزيع المهام والاستفادة من خبرات مختلفة','إطالة مدة العمل فقط','لا دور له'],c:'توزيع المهام والاستفادة من خبرات مختلفة'},
      {q:'ما المقصود بالتكامل بين المواد؟',a:['استخدام مواد مختلفة لتأدية وظائف متعددة','خلط المواد بشكل عشوائي','استخدام مادة واحدة فقط'],c:'استخدام مواد مختلفة لتأدية وظائف متعددة'},
      {q:'ما المقصود بخطة السلامة؟',a:['إجراءات لمنع الحوادث وحماية الفريق','تسويق المنتج','تقليل الجودة'],c:'إجراءات لمنع الحوادث وحماية الفريق'},
      {q:'كيف نحدد معايير نجاح المشروع؟',a:['عن طريق مواصفات الأداء والوظائف المطلوبة','بناء شعار جميل','زيادة التكلفة'],c:'عن طريق مواصفات الأداء والوظائف المطلوبة'},
      {q:'ما المقصود بالتحسين المستمر؟',a:['مراجعة وتطوير المنتج بانتظام','التوقف بعد الإنتاج','التسويق فقط'],c:'مراجعة وتطوير المنتج بانتظام'},
      {q:'ما فائدة تحليل المخاطر في المشروع؟',a:['التنبؤ بالمشاكل وتقليل أثرها','زيادة العمل الورقي فقط','تأجيل التنفيذ'],c:'التنبؤ بالمشاكل وتقليل أثرها'},
      {q:'ما المقصود بتقييم التكلفة؟',a:['تقدير الموارد المالية المطلوبة للمشروع','قياس طول المشروع','حساب عدد العمال فقط'],c:'تقدير الموارد المالية المطلوبة للمشروع'}
    ]
  };

  questions = shuffle(bank[challenge]).slice(0, 10);
  currentQuestionIndex = 0;
  score = 0;
  showQuestion();
}

function showQuestion() {
  const q = questions[currentQuestionIndex];
  const qBox = document.getElementById('question-box');
  qBox.textContent = `السؤال ${currentQuestionIndex + 1}: ${q.q}`;
  const ansDiv = document.getElementById('answers');
  ansDiv.innerHTML = '';
  let opts = shuffle([...q.a]);
  opts.forEach(opt => {
    const b = document.createElement('button');
    b.textContent = opt;
    b.onclick = () => checkAnswer(opt, q.c, b);
    ansDiv.appendChild(b);
  });
}

function checkAnswer(sel, correct, btn) {
  const btns = document.querySelectorAll('#answers button');
  btns.forEach(b => b.disabled = true);
  if (sel === correct) { btn.style.background = 'green'; score++; }
  else {
    btn.style.background = 'red';
    btns.forEach(b => { if (b.textContent === correct) b.style.background = 'green'; });
  }
}

function nextQuestion() {
  if (currentQuestionIndex < questions.length - 1) { currentQuestionIndex++; showQuestion(); }
  else showResult();
}

function showResult() {
  document.getElementById('quiz-container').classList.add('hidden');
  document.getElementById('result-container').classList.remove('hidden');
  const n = document.getElementById('student-name').value;
  const c = document.getElementById('student-class').value;
  const scorePercent = Math.round((score / questions.length) * 100);
  const date = new Date().toLocaleDateString('ar-DZ');
  const titles = {
    institution: 'تحدي المؤسسة الإنتاجية',
    representation: 'تحدي اتفاقيات التمثيل',
    cad: 'تحدي الرسم بالحاسوب',
    tech: 'تحدي التكنولوجيا والمنتوج التقني',
    project: 'تحدي مسعى المشروع'
  };
  document.getElementById('result-challenge').textContent = titles[currentChallenge];
  document.getElementById('result-name').textContent = 'الاسم واللقب: ' + n;
  document.getElementById('result-class').textContent = 'القسم: ' + c;
  document.getElementById('result-score').textContent = 'النتيجة: ' + scorePercent + '%';
  document.getElementById('result-date').textContent = 'التاريخ: ' + date;

  let msg = '';
  if (scorePercent >= 90) msg = '🌟 ممتاز! أداء رائع يدل على فهم عميق!';
  else if (scorePercent >= 70) msg = '👍 جيد جدًا! واصل العمل لتصل إلى التميز!';
  else if (scorePercent >= 50) msg = '💪 أداء مقبول، حاول مراجعة بعض المفاهيم!';
  else msg = '😅 لا بأس! حاول من جديد وستتحسن بالتأكيد!';
  document.getElementById('motivation').textContent = msg;
}

function printResult() { window.print(); }

function restart() {
  document.getElementById('result-container').classList.add('hidden');
  document.getElementById('challenge-selection').classList.remove('hidden');
}
